\chapter{Partitioned finite element method}

\epigraph{Every truth is simple\dots is that not doubly a lie?}{\textit{Twilight of the Idols \\ Friedrich Nietzsche}}

\minitoc

\lettrine{\color{theme}{D}}iscretization is the process of transferring continuous models into discrete counterparts. The discrete model should be faithful to the continuous one. To this aim, it is usually essential that the main properties of the continuous system are preserved at the discrete level. An algorithm that is capable of conserving properties at the discrete level is called structure-preserving \cite{christiansen2011}. In this chapter, a finite element method to spatially discretize infinite-dimensional pHs into finite-dimensional ones in a structure preserving manner is illustrated.

\section{Discretization under uniform boundary condition}
A discrete version of a infinite-dimensional pH system is meant to preserve the underlying properties related to power continuity. To achieve this purpose, the discretization procedure consists of two steps \cite{kotyczka2018weak}:
\begin{itemize}
	\item Finite-dimensional approximation of the Stokes-Dirac structure, i.e. the formally skew symmetric differential operator that defines the structure. The duality of the power variables has to be mapped onto the finite approximation. The subspace of the discrete variables will be represented by a Dirac structure. 
	\item The Hamiltonian requires as well a suitable discretization, which gives rise to a discrete Hamiltonian. 
\end{itemize} 
A structure-preserving discretization is able to construct an equivalent pH system that possess the structural properties of the original model:
\begin{tcbraster}[raster columns=2, raster equal height]
	\begin{tcolorbox}[width=0.4\textwidth, nobeforeafter, colframe=theme,title=Infinite dimensional pH system]%%
		PDE with distributed inputs:
		\begin{align*}
		\diffp{\bm{\alpha}}{t}(\bm{x}, t) &= \mathcal{J} {\displaystyle \diffd{H}{\bm{\alpha}}}+ \mathcal{B} \textcolor{red}{\bm{u}(\bm{x}, t)}, \\
		\textcolor{red}{\bm{y}(\bm{x}, t)} &= \mathcal{B}^* {\displaystyle \diffd{H}{\bm{\alpha}}}.
		\end{align*}
		Boundary conditions: 
		\[\textcolor{blue}{\bm{u}_\partial} = \mathcal{B}_\partial{\displaystyle \diffd{H}{\bm{\alpha}}}, \quad \textcolor{blue}{\bm{y}_\partial} = \mathcal{C}_\partial {\displaystyle \diffd{H}{\bm{\alpha}}}. \]
		Power balance (Stokes Theorem): 
		\[ \dot{H} = \displaystyle \int_{\partial \Omega} \textcolor{blue}{\bm{u}_\partial} \cdot \textcolor{blue}{\bm{y}_\partial} \d{S} +  \int_{\Omega} \textcolor{red}{\bm{u}} \cdot \textcolor{red}{\bm{y}} \d{\Omega}.
		\]
	\end{tcolorbox} 
	\begin{tcolorbox}[width=0.4\textwidth, nobeforeafter,  colframe=theme,title=Structure-preserving discretization]%%
		Resulting ODE:
		\begin{align*}
		\dot{\bm{\alpha}}_d &= \mathbf{J} \, {\nabla {H}_d} + \mathbf{B}_d \textcolor{red}{\mathbf{u}_d} + \mathbf{B}_\partial \textcolor{blue}{\mathbf{u}_\partial}, \\
		\textcolor{red}{\mathbf{y}_d} &= \mathbf{B}_d^\top \, {\nabla {H}_d}, \\
		\textcolor{blue}{\mathbf{y}_\partial} &= \mathbf{B}_\partial^\top \,{\nabla {H}_d}.
		\end{align*}
		Discretized Hamiltonian:
		\[
		H_d := H(\bm{\alpha} \equiv \bm{\alpha}_d).
		\]
		Power balance: 
		\[ \dot{H} = \textcolor{blue}{\mathbf{u}_\partial^\top \mathbf{y}_\partial} +  \textcolor{red}{\mathbf{u}_d^\top \mathbf{y}_d}.
		\]
	\end{tcolorbox}
\end{tcbraster}
\vspace{.5cm}
In this thesis the partitioned finite element method (PFEM), originally presented in \cite{cardoso2018pfem,cardoso2019partitioned}, is chosen to obtain discretized models of dpHs. This procedure boils down to three simple steps
\begin{enumerate}
	\item The system is written in weak form; 
	\item An integration by parts is applied to highlight the appropriate boundary control;
	\item A Galerkin method is employed to obtain a finite-dimensional system.
\end{enumerate}

Once the system has been put into weak form, a subset of the equations is integrated by parts, so that boundary variables are naturally included into the formulation and appear as control inputs, the collocated outputs being defined accordingly. The discretization of energy and co-energy variables (and the associated test functions) leads directly to a full rank representation for the finite-dimensional pH system.  This approach makes possible the usage of FEM software, like FEniCS \cite{logg2012}, or Firedrake \cite{rathgeber2017firedrake}. \\

Despite the many advantages, this methodology allows obtaining a canonical pH finite dimensional system only under a uniform causality assumption. The case of mixed boundary conditions requires additional care and will be treated in the subsequent Section \secref{sec:mixedbc}.


\subsection{General procedure}
Given an open connected set $\Omega \in \mathbb{R}^d,\, d= \{1,2,3\}$, consider a generic pH system defined on~$\Omega$
\begin{align}
\partial_t {\bm{\alpha}} &= \mathcal{J}\displaystyle \bm{e}, \qquad \;\;\, \bm{\alpha} \in X, \label{eq:pHsys_dyn} \vspace{3pt}\\
\bm{u}_\partial &= \mathcal{B}_\partial  \displaystyle \bm{e}, \qquad \bm{u}_\partial \in \mathbb{R}^m \label{eq:pHsys_u} \vspace{3pt}\\
\bm{y}_\partial &= \mathcal{C}_\partial \displaystyle \bm{e}, \qquad \; \bm{y}_\partial \in \mathbb{R}^m \label{eq:pHsys_y} \vspace{3pt}\\
\bm{e} :&= \displaystyle \delta_{\bm{\alpha}}H, \qquad \;\; \bm{e} \in H^\mathcal{J}. \label{eq:pHsys_const}
\end{align}
The Hilbert space $X$, whose inner product is denoted by $\inner[X]{\cdot}{\cdot}$, is an appropriate Cartesian product of $L^2$ spaces which account for the nature of each variable (that can be scalar, vectorial or tensorial quantities). Its precise definition depends on the example upon consideration. The Hilbert space $H^\mathcal{J}$ is defined to be 
\begin{equation}
	H^\mathcal{J} :=\left\{\bm{u} \in X \vert \; \mathcal{J}\bm{u} \in X  \right\}.
\end{equation}
 The Hamiltonian functional of Eq. \eqref{eq:pHsys_const} is allowed to be non linear in the energy variables
\begin{equation*}
H = \int_\Omega \mathcal{H}(\bm{\alpha}) \d\Omega,
\end{equation*}
where $\mathcal{H}(\bm{\alpha}): X \rightarrow \mathbb{R}$ is a non linear function.
\\

To applied this methodology the non linearities are restricted to the Hamiltonian and a uniform causality condition is supposed to characterize the system. It is required as well that the system admits a splitting of the variables. This requirement is always encounter in the following examples. These hypotheses are resumed in the following assumptions.

\begin{assumption}\label{ass:linJ}
	Consider system \eqref{eq:pHsys_dyn}. It is assumed that the Hilbert space $X$ admits the splitting $X = X_1 \times X_2$ (meaning that the system does not consist of a single scalar equation). The operator $\mathcal{J}$ is assumed to be skew-symmetric (or formally skew-adjoint) on $X$ and linear:
	\begin{equation}\label{eq:assJ}
	\mathcal{J} = \mathcal{J}_{{a}} + \mathcal{J}_{{d}},
	\end{equation}
	where $\mathcal{J}_{\text{a}}$ is the algebraic contribution (a skew-symmetric matrix) and $\mathcal{J}_{\text{d}}$ the differential contribution. The algebraic part is assumed to take the form
	\begin{equation}\label{eq:assJa}
		\mathcal{J}_{{a}} = \begin{bmatrix}
		0 & -\bm{L}^\top \\
		\bm{L} & 0 \\
		\end{bmatrix}, \qquad 
		\begin{aligned}
		&\bm{L}^\top : X_2 \rightarrow X_1, \\
		&\bm{L}\;\, : X_1 \rightarrow X_2, \\
		\end{aligned}
	\end{equation}
	where $\bm{L}$ is a matrix (a bounded operator). 	Analogously, he linear differential operator $\mathcal{J}_{{d}}$ is assumed to be of the form
	\begin{equation}\label{eq:assJd}
	\mathcal{J}_{\text{d}} = 
	\begin{bmatrix}
	0 & -\mathcal{L}^* \\
	\mathcal{L} & 0 \\
	\end{bmatrix}, \qquad 
	\begin{aligned}
	&\mathcal{L}^* : X_2 \rightarrow X_1, \\
	&\mathcal{L}\;\, : X_1 \rightarrow X_2, \\
	\end{aligned}
	\end{equation}
	where $\mathcal{L}^*$ denotes the formal adjoint of the linear differential operator $\mathcal{L}$.
	The operator $\mathcal{L}$ is unbounded and  can be either a first order or a second order differential operator. In the latter case it can be expressed as $\mathcal{L} = \mathcal{L}_1 \circ \mathcal{L}_2$. Given the splitting $X_1 \times X_2 = X$ the Hilbert space $H^\mathcal{J}$ can be split as well as 
	\begin{equation}
		H^\mathcal{J} = H^\mathcal{L} \times H^\mathcal{-L^*}, \qquad
		\begin{aligned}
		H^\mathcal{L} &:= \left\{\bm{u}_1 \in X_1 \vert \; \mathcal{L}\bm{u}_1 \in X_2 \right\}, \\
		H^\mathcal{-L^*} &:= \left\{\bm{u}_2 \in X_2 \vert \; -\mathcal{L}^*\bm{u}_2 \in X_1 \right\}
		\end{aligned}
	\end{equation}
\end{assumption}

From Theorem \ref{th:rogers}, given $(\bm{u}_1, \, \bm{u}_2) \in H^\mathcal{L} \times H^\mathcal{-L^*}= H^{\mathcal{J}}$, it holds
\begin{equation}
\inner[X_2]{\bm{u}_2}{\mathcal{L}\, \bm{u}_1}  - \inner[X_1]{\mathcal{L}^* \, \bm{u}_2} {\bm{u}_1} = \int_{\Omega }\div\widetilde{\mathcal{A}}_{\mathcal{L}}(\bm{u}_1, \bm{u}_2) \d\Omega. \\
\end{equation}
The integration by part formula provides 
\begin{equation}
\inner[X_2]{\bm{u}_2}{\mathcal{L}\,\bm{u}_1} - \inner[X_1]{\mathcal{L}^* \, \bm{u}_2}{\bm{u}_1} = \inner[X_\partial]{\mathcal{N}_{\partial, 1} \bm{u}_1}{\mathcal{N}_{\partial, 2} \bm{u}_2}. \label{eq:intbypartsJ} 
\end{equation}
where $X_\partial = L^2(\partial \Omega, \mathbb{R}^m)$. The boundary operators are then supposed to fulfill the following assumption, that guarantees a uniform causality condition.


\begin{assumption}\label{ass:operBC}
	The boundary operators $\mathcal{B}_\partial, \, \mathcal{C}_\partial$ of Eqs. \eqref{eq:pHsys_u}, \eqref{eq:pHsys_y}, are assumed to verify, in an exclusive manner, either
	\begin{equation}\label{eq:assB1C2}
	\mathcal{B}_\partial = \begin{bmatrix}
	\mathcal{N}_{\partial, 1} & 0 \\
	\end{bmatrix}, \quad \mathcal{C}_\partial = \begin{bmatrix}
	0 & \mathcal{N}_{\partial, 2} \\
	\end{bmatrix}
	\end{equation}
	or 
	\begin{equation}\label{eq:assB2C1}
	\mathcal{B}_\partial = \begin{bmatrix}
	0 & \mathcal{N}_{\partial, 2} \\
	\end{bmatrix}, \quad 
	\mathcal{C}_\partial = \begin{bmatrix}
	\mathcal{N}_{\partial, 1} & 0 \\
	\end{bmatrix}
	\end{equation}
	where the operators $\mathcal{N}_{\partial, 1}, \; \mathcal{N}_{\partial, 2}$ are defined by the integration by part formula \eqref{eq:intbypartsJ}. 

\end{assumption}


We are now in a position to illustrate the methodology. 
\paragraph{Step 1} First consider the weak form of system \eqref{eq:pHsys_dyn}
\begin{equation}
\inner[X]{\bm{v}}{\partial_t \bm{\alpha}} = \inner[X]{\bm{v}}{\mathcal{J} \bm{e}}.
\end{equation}
The weak form is obtained by taking the $L^2$ inner product introducing an appropriate test function $\bm{v} \in X$ and integrating over the domain $\Omega$. Introducing Assumption \ref{ass:linJ}, one obtains


\begin{align}
\inner[X]{\bm{v}}{\partial_t \bm{\alpha}} &= \inner[X]{\bm{v}}{\mathcal{J} \bm{e}}, \\
{\inner[X]{\bm{v}}{\partial_t \bm{\alpha}}} &\stackrel{\text{Eq. \eqref{eq:assJ}}}{=} \inner[X]{\bm{v}}{\mathcal{J}_a\bm{e}} + \inner[X]{\bm{v}}{\mathcal{J}_{d}\bm{e}}, \\  
\inner[X]{\bm{v}}{\partial_t \bm{\alpha}} &\stackrel{\text{Eqs. \eqref{eq:assJa} \eqref{eq:assJd}}}{=} -  \langle{\bm{v}_1},\,{\bm{L}^\top \bm{e}_2}\rangle_{X_1} + \inner[X_2]{\bm{v}_2}{\bm{L}\bm{e}_1}-  \inner[X_1]{\bm{v}_1}{\mathcal{L}^*\bm{e}_2} + \inner[X_2]{\bm{v}_2}{\mathcal{L}\bm{e}_1}. \label{eq:weak_dyn}
\end{align}


To obtain a closed system, the constitutive law \eqref{eq:pHsys_const} and the output variables are put in weak form
\begin{align}
\inner[X]{\bm{v}}{\bm{e}}&= \inner[X]{\bm{v}}{\delta_{\bm{\alpha}} H}, \\
\inner[X_\partial]{\bm{v}_\partial}{\bm{y}_\partial} &= \inner[X_\partial]{\bm{v}_\partial}{\mathcal{C}_\partial \bm{e}},
\end{align}
where the test function $\bm{v}_\partial \in X_\partial = L^2(\partial \Omega, \mathbb{R}^m)$ is defined on the boundary $\partial\Omega$.


\paragraph{Step 2} Next the integration by part has to be carried out. The choice is dictated by the boundary control to be imposed on the system. Consider again Eq. \eqref{eq:weak_dyn}. The integration by parts can be carried out either on term $-\inner[X_1]{\bm{v}_1}{\mathcal{L}^*\bm{e}_2}$, or on term $\inner[X_2]{\bm{v}_2}{\mathcal{L}\bm{e}_1}$. Depending o which line undergoes the integration by parts (this explains the name Partitioned Finite Element method), two structure preserving weak forms are obtained. These differ by the boundary causality imposed to the system. 


\subparagraph{Integration by parts of the term $-\inner[X_1]{\bm{v}_1}{\mathcal{L}^*\bm{e}_2}$}
In this case case, using Eq. \eqref{eq:intbypartsJ}, it is obtained 
\begin{equation}
-\inner[X_1]{\bm{v}_1}{\mathcal{L}^*\bm{e}_2} = -\inner[X_2]{\mathcal{L}\bm{v}_1}{\bm{e}_2} + \inner[X_\partial]{\mathcal{N}_{\partial, 1} \bm{v}_1}{\mathcal{N}_{\partial, 2} \bm{e}_2}.
\end{equation}
Then the weak form of the system dynamics  reads 
\begin{equation}\label{eq:weak_dyn_intJ1}
\inner[X]{\bm{v}}{\partial_t \bm{\alpha}} =   -\langle{\bm{v}_1},\, {\bm{L}^\top \bm{e}_2}\rangle_{X_1} + \inner[X_2]{\bm{v}_2}{\bm{L}\bm{e}_1} -\inner[X_2]{\mathcal{L}\bm{v}_1}{\bm{e}_2} + \inner[X_2]{\bm{v}_2}{\mathcal{L}\bm{e}_1} + \inner[X_\partial]{\mathcal{N}_{\partial, 1} \bm{v}_1}{\mathcal{N}_{\partial, 2} \bm{e}_2}. 
\end{equation}
The following proposition is crucial as the lossless character of the infinite-dimensional system (due to the formally skew-adjoint operator) translates into an equivalent property for the corresponding bilinear form in the weak form.
\begin{proposition}
	Given the Hilbert space $H^{\mathcal{L}}_2 := H^\mathcal{L} \times X_2$ and variables $\bm{v} = (\bm{v}_1, \bm{v}_2) \in H^{\mathcal{L}}_2, \; \bm{e} = (\bm{e}_1, \bm{e}_2) \in H^{\mathcal{L}}_2$, the bilinear form 
	\begin{equation*}
	\begin{aligned}
	j_\mathcal{L}: H^{\mathcal{L}}_2 \times H^{\mathcal{L}}_2 &\longrightarrow \mathbb{R}, \\
	(\bm{v}, \bm{e}) &\longrightarrow -\inner[X_2]{\mathcal{L}\bm{v}_1}{\bm{e}_2} + \inner[X_2]{\bm{v}_2}{\mathcal{L}\bm{e}_1}
	\end{aligned}
	\end{equation*}
	is skew-symmetric.
	\begin{proof}
		The proof is obtained by the following computation
		\begin{equation*}
		\begin{aligned}
		j_\mathcal{L}(\bm{v}, \bm{e}) &= -\inner[X_2]{\mathcal{L}\bm{v}_1}{\bm{e}_2} + \inner[X_2]{\bm{v}_2}{\mathcal{L}\bm{e}_1}, \\
		&= - \left( - \inner[X_2]{\bm{v}_2}{\mathcal{L}\bm{e}_1} + \inner[X_2]{\mathcal{L}\bm{v}_1}{\bm{e}_2}\right), \\
		&= - \left( - \inner[X_2]{\mathcal{L}\bm{e}_1}{\bm{v}_2} + \inner[X_2]{\bm{e}_2}{\mathcal{L}\bm{v}_1}\right) = - j_\mathcal{L}(\bm{e}, \bm{v}).
		\end{aligned}
		\end{equation*}
	\end{proof}
\end{proposition}

Now assume that the system satisfies the boundary causality condition \eqref{eq:assB2C1}, i.e.  
\begin{equation*}
\bm{u}_\partial=\mathcal{N}_{\partial, 2} \bm{e}_2, \qquad \bm{y}_\partial=\mathcal{N}_{\partial, 1} \bm{e}_1
\end{equation*}. 
Then, this choice of the integration by parts lead to the following weak formulation
\begin{equation}\label{eq:weak_sys_intJ1}
\begin{aligned}
\inner[X]{\bm{v}}{\partial_t \bm{\alpha}} &=   -  \langle{\bm{v}_1}, \,{\bm{L}^\top \bm{e}_2}\rangle_{X_1} + \inner[X_2]{\bm{v}_2}{\bm{L}\bm{e}_1} -\inner[X_2]{\mathcal{L}\bm{v}_1}{\bm{e}_2} + \inner[X_2]{\bm{v}_2}{\mathcal{L}\bm{e}_1} + \inner[X_\partial]{\mathcal{N}_{\partial, 1} \bm{v}_1}{\bm{u}_\partial}, \\
\inner[X]{\bm{v}}{\bm{e}}&=\inner[X]{\bm{v}}{\delta_{\bm{\alpha}} H}, \\
\inner[X_\partial]{\bm{v}_\partial}{\bm{y}_\partial} &= \inner[X_\partial]{\bm{v}_\partial}{\mathcal{N}_{\partial, 1}\bm{e}_2}.
\end{aligned}
\end{equation}

\subparagraph{Integration by parts of the term $\inner[X_2]{\bm{v}_2}{\mathcal{L}\bm{e}_1}$}
Using Eq. \eqref{eq:intbypartsJ}, it is obtained 
\begin{equation}
\inner[X_2]{\bm{v}_2}{\mathcal{L}\bm{e}_1} = \inner[X_1]{\mathcal{L}^*\bm{v}_2}{\bm{e}_1} + \inner[X_\partial]{\mathcal{N}_{\partial, 2} \bm{v}_2}{\mathcal{N}_{\partial, 1} \bm{e}_1}.
\end{equation}
Then the weak form of the system dynamics  reads 
\begin{equation}\label{eq:weak_dyn_intJ2}
\inner[X]{\bm{v}}{\partial_t \bm{\alpha}} =   -  \langle{\bm{v}_1}, \,{\bm{L}^\top \bm{e}_2}\rangle_{X_1} + \inner[X_2]{\bm{v}_2}{\bm{L}\bm{e}_1} -\inner[X_1]{\bm{v}_1}{\mathcal{L}^*\bm{e}_2} + \inner[X_1]{\mathcal{L}^*\bm{v}_2}{\bm{e}_1} + \inner[X_\partial]{\mathcal{N}_{\partial, 2} \bm{v}_2}{\mathcal{N}_{\partial, 1} \bm{e}_1}. 
\end{equation}
Again the bilinear form arising from the formally skew-adjoint operator is skew-symmetric.
\begin{proposition}
	Given the Hilbert space $H^{-\mathcal{L}^*}_1 = X_1 \times H^{-\mathcal{L}^*}$ and variables $\bm{v} = (\bm{v}_1, \bm{v}_2) \in H^{-\mathcal{L}^*}_1, \; \bm{e} = (\bm{e}_1, \bm{e}_2) \in H^{-\mathcal{L}^*}_1$, the bilinear form 
	\begin{equation*}
	\begin{aligned}
	j_{-\mathcal{L}^*}: H^{-\mathcal{L}^*}_1 \times H^{-\mathcal{L}^*}_1 &\longrightarrow \mathbb{R}, \\
	(\bm{v}, \bm{e}) &\longrightarrow -\inner[X_1]{\bm{v}_1}{\mathcal{L}^*\bm{e}_2} + \inner[X_1]{\mathcal{L}^*\bm{v}_2}{\bm{e}_1}
	\end{aligned}
	\end{equation*}
	is skew-symmetric.
	\begin{proof}
		The proof follows from the computation
		\begin{equation*}
		\begin{aligned}
		j_{-\mathcal{L}^*}(\bm{v}, \bm{e}) &= -\inner[X_1]{\bm{v}_1}{\mathcal{L}^*\bm{e}_2} + \inner[X_1]{\mathcal{L}^*\bm{v}_2}{\bm{e}_1}, \\
		&= - \left(-\inner[X_1]{\mathcal{L}^*\bm{v}_2}{\bm{e}_1} + \inner[X_1]{\bm{v}_1}{\mathcal{L}^*\bm{e}_2}\right), \\
		&= - \left(-\inner[X_1]{\bm{e}_1}{\mathcal{L}^*\bm{v}_2} + \inner[X_1]{\mathcal{L}^*\bm{e}_2}{\bm{v}_1}\right) = - j_{-\mathcal{L}^*}(\bm{e}, \bm{v}).
		\end{aligned}
		\end{equation*}
	\end{proof}
\end{proposition}

Now assume that the system satisfies the boundary causality condition \eqref{eq:assB1C2}, i.e.  
\begin{equation*}
\bm{u}_\partial=\mathcal{N}_{\partial, 1} \bm{e}_1, \qquad \bm{y}_\partial=\mathcal{N}_{\partial, 2} \bm{e}_2
\end{equation*}. 
Then, the final weak formulation reads
\begin{equation}\label{eq:weak_sys_intJ2}
\begin{aligned}
\inner[X]{\bm{v}}{\partial_t \bm{\alpha}} &=   -  \langle{\bm{v}_1}, \,{\bm{L}^\top \bm{e}_2}\rangle_{X_1} + \inner[X_2]{\bm{v}_2}{\bm{L}\bm{e}_1} -\inner[X_1]{\bm{v}_1}{\mathcal{L}^*\bm{e}_2} + \inner[X_1]{\mathcal{L}^*\bm{v}_2}{\bm{e}_1} + \inner[X_\partial]{\mathcal{N}_{\partial, 2} \bm{v}_2}{\bm{u}_{\partial}}, \\
\inner[X]{\bm{v}}{\bm{e}}&= \inner[X]{\bm{v}}{\delta_{\bm{\alpha}} H}, \\
\inner[X_\partial]{\bm{v}_\partial}{\bm{y}_\partial} &= \inner[X_\partial]{\bm{v}_\partial}{\mathcal{N}_{\partial, 2}\bm{e}_2}.
\end{aligned}
\end{equation}

\paragraph{Galerkin discretization}
To conclude the illustration of this methodology, consider a Galerkin discretization is introduced. This means that corresponding test and trial functions are discretized using the same basis
\begin{equation}\label{eq:approx_ve}
\begin{aligned}
\bm{v}_1 \approx \sum_{i=1}^{n_1} \bm{\phi}_1^i v_1^i, \\
\bm{v}_2 \approx \sum_{i=1}^{n_2} \bm{\phi}_2^i v_2^i, 
\end{aligned} \qquad 
\begin{aligned}
\bm{\alpha}_1 \approx \sum_{i=1}^{n_1} \bm{\phi}_1^i \alpha_1^i, \\
\bm{\alpha}_2 \approx \sum_{i=1}^{n_2} \bm{\phi}_2^i \alpha_2^i. 
\end{aligned} \qquad 
\begin{aligned}
\bm{e}_1 \approx \sum_{i=1}^{n_1} \bm{\phi}_1^i e_1^i, \\
\bm{e}_2 \approx \sum_{i=1}^{n_2} \bm{\phi}_2^i e_2^i. 
\end{aligned}
\end{equation}
A finite dimensional approximation is introduced for the boundary variables as well
\begin{equation}\label{eq:approx_boundar}
\bm{v}_\partial \approx \sum_{i=1}^{n_\partial} \bm{\phi}_\partial^i v_\partial^i, \qquad
\bm{u}_\partial \approx \sum_{i=1}^{n_\partial} \bm{\phi}_\partial^i u_\partial^i, \qquad
\bm{y}_\partial \approx \sum_{i=1}^{n_\partial} \bm{\phi}_\partial^i y_\partial^i.
\end{equation}
\subparagraph{Discretization of the weak form \eqref{eq:weak_sys_intJ1}}
Plugging the approximation into the weak form \eqref{eq:weak_sys_intJ1} and consider that the resulting equation holds $\forall \, v_1^i,\, v_2^j,\, v_\partial^k \; (i\in\left\{1,n_1\right\}, \; j\in\left\{1,n_2\right\}, \; k\in\left\{1,n_\partial\right\})$, the finite dimensional system is obtained

\begin{equation}\label{eq:pHsys_findim_J1}
\begin{aligned}
\begin{bmatrix}
\mathbf{M}_1 & \mathbf{0} \\
\mathbf{0} & \mathbf{M}_2 \\
\end{bmatrix}
\begin{bmatrix}
\dot{\bm{\alpha}}_{d, 1} \\
\dot{\bm{\alpha}}_{d, 2} \\
\end{bmatrix}
&= \begin{bmatrix}
\mathbf{0} & -\mathbf{D}_{0}^\top - \mathbf{D}_{\mathcal{L}}^\top \\
\mathbf{D}_{0} + \mathbf{D}_{\mathcal{L}} & \mathbf{0} \\
\end{bmatrix} 
\begin{bmatrix}
\mathbf{e}_{1} \\
\mathbf{e}_{2} \\
\end{bmatrix} + 
\begin{bmatrix}
\mathbf{B}_1\\
\mathbf{0}\\
\end{bmatrix}
\mathbf{u}_\partial, \\
\begin{bmatrix}
\mathbf{M}_1 & \mathbf{0} \\
\mathbf{0} & \mathbf{M}_2 \\
\end{bmatrix}
\begin{bmatrix}
\mathbf{e}_{1} \\
\mathbf{e}_{2} \\
\end{bmatrix}
&= \begin{bmatrix}
\partial_{\bm{\alpha}_{d, 1}} H_d(\bm{\alpha}_d)\\
\partial_{\bm{\alpha}_{d, 2}} H_d(\bm{\alpha}_d)\\
\end{bmatrix}, \\
\mathbf{M}_\partial {\mathbf{y}_\partial} &= \begin{bmatrix}
\mathbf{B}_1^\top & \mathbf{0}
\end{bmatrix}\begin{bmatrix}
\mathbf{e}_{1} \\
\mathbf{e}_{2} \\
\end{bmatrix}.
\end{aligned}
\end{equation}
Vectors $\bm{\alpha}_{d, 1},\, \bm{\alpha}_{d, 2}, \, \mathbf{e}_{1}, \, \mathbf{e}_{2}, \, \mathbf{u}_\partial, \, \mathbf{y}_\partial$ are given by the column-wise concatenation of their respective degrees of freedom. The matrices are defined as follows 
\begin{equation}
\begin{aligned}
M_1^{ij} &= \inner[X_1]{\phi_1^i}{\phi_1^j}, \\
M_2^{ij} &= \inner[X_2]{\phi_2^i}{\phi_2^j}, \\
\end{aligned}\quad
\begin{aligned}
{D}_{0}^{ji} &= \inner[X_2]{\phi_2^j}{\bm{L}\phi_1^i}, \\
{D}_{\mathcal{L}}^{ji} &= \inner[X_2]{\phi_2^j}{\mathcal{L}\phi_1^i}, 
\end{aligned}\quad  
\begin{aligned}
{B}_{1}^{ik} = \inner[X_\partial]{\phi_1^i}{\phi_\partial^k}, \\
M_\partial^{lk} = \inner[X_\partial]{\phi_\partial^l}{\phi_\delta^k}
\end{aligned}
\end{equation}
where $i \in \left\{1, n_1\right\}, \; j \in \left\{1, n_2\right\}, \; l \in \left\{1, n_\partial \right\}, \; k \in \left\{1, n_\partial \right\}$. Introducing the definitions
\begin{align*}
	\delta_{\bm{\alpha}_{d, 1}} H_d := \delta_{\bm{\alpha}_{1}} H\left(\bm{\alpha}_1 = \sum_{i=1}^{n_1} \bm{\phi}_1^i \alpha_1^i, \;  \bm{\alpha}_2 = \sum_{i=1}^{n_1} \bm{\phi}_2^i \alpha_2^i\right), \\
	\delta_{\bm{\alpha}_{d, 2}} H_d := \delta_{\bm{\alpha}_{2}} H\left(\bm{\alpha}_1 = \sum_{i=1}^{n_1} \bm{\phi}_1^i \alpha_1^i, \;  \bm{\alpha}_2 = \sum_{i=1}^{n_1} \bm{\phi}_2^i \alpha_2^i\right),
\end{align*}
the discretized gradient of the Hamiltonian read
\begin{equation}
\begin{aligned}
\partial_{{\alpha}_{d, 1}^i} H_d(\bm{\alpha}_d) &= \inner[X_1]{\phi_1^i}{\delta_{\bm{\alpha}_{d, 1}} H_d}, \qquad i \in \left\{1, n_1\right\}, \\
\partial_{{\alpha}_{d, 2}^j} H_d(\bm{\alpha}_d) &= \inner[X_2]{\phi_2^j}{\delta_{\bm{\alpha}_{d, 2}} H_d}, \qquad j \in \left\{1, n_2\right\}.
\end{aligned}
\end{equation}
A pH system in canonical form can be found observing that Sys. \eqref{eq:pHsys_findim_J1} is compactly rewritten as 
\begin{align}
\mathbf{M} \dot{\bm{\alpha}}_{d} &= \mathbf{J}_{\mathcal{L}} \mathbf{e} + \mathbf{B}\mathbf{u}_\partial, \label{eq:pHfindim_dyn1} \\
\mathbf{M} \mathbf{e} &= \nabla H_d(\bm{\alpha}_d), \label{eq:pHfindin_e}\\
\mathbf{M}_\partial {\mathbf{y}_\partial} &= \mathbf{B}^\top \mathbf{e},
\end{align}

where $\bm{\alpha}_{d}= [\bm{\alpha}_{d, 1}^\top \; \bm{\alpha}_{d, 2}^\top]^\top, \; \mathbf{e}= [\mathbf{e}_1^\top \; \mathbf{e}_2^\top]^\top, \; \nabla H_d(\bm{\alpha}_d) = [\partial_{\bm{\alpha}_{d, 1}}^\top H_d(\bm{\alpha}_d) \; \partial_{\bm{\alpha}_{d, 2}}^\top H_d(\bm{\alpha}_d)]^\top$ and 
\begin{equation}
\mathbf{M} = \begin{bmatrix}
\mathbf{M}_1 & \mathbf{0} \\
\mathbf{0} & \mathbf{M}_2 \\
\end{bmatrix}, \qquad 
\mathbf{J}_\mathcal{L}= \begin{bmatrix}
\mathbf{0} & -\mathbf{D}_{0}^\top - \mathbf{D}_{\mathcal{L}}^\top \\
\mathbf{D}_{0} + \mathbf{D}_{\mathcal{L}} & \mathbf{0} \\
\end{bmatrix}, \qquad
\mathbf{B} =
\begin{bmatrix}
\mathbf{B}_1\\
\mathbf{0}\\
\end{bmatrix}.
\end{equation}
Plugging \eqref{eq:pHfindin_e} into \eqref{eq:pHfindim_dyn1}, a pH system in canonical form is obtained
\begin{equation}
	\begin{aligned}
	\dot{\bm{\alpha}}_{d} &= \mathbf{J}\, \nabla H_d(\bm{\alpha}_d) + \mathbf{B}\, \mathbf{u}_\partial,\\
	\widehat{\mathbf{y}}_\partial &= \mathbf{B}^\top \nabla H_d(\bm{\alpha}_d), 
	\end{aligned}
	\begin{aligned}
	\where \mathbf{J} &= \mathbf{M}^{-1} \mathbf{J}_\mathcal{L} \mathbf{M}^{-1},\\
	\where \widehat{\mathbf{y}}_\partial &= \mathbf{M}_\partial \mathbf{y}_\partial.
	\end{aligned}
\end{equation}
\subparagraph{Discretization of the weak form \eqref{eq:weak_sys_intJ2}}
Plugging the approximation into the weak form \eqref{eq:weak_sys_intJ2} a finite dimensional system with a different causality is obtained

\begin{equation}\label{eq:pHsys_findim_J2}
\begin{aligned}
\begin{bmatrix}
\mathbf{M}_1 & \mathbf{0} \\
\mathbf{0} & \mathbf{M}_2 \\
\end{bmatrix}
\begin{bmatrix}
\dot{\bm{\alpha}}_{d, 1} \\
\dot{\bm{\alpha}}_{d, 2} \\
\end{bmatrix}
&= \begin{bmatrix}
\mathbf{0} & -\mathbf{D}_{0}^\top + \mathbf{D}_{-\mathcal{L}^*} \\
\mathbf{D}_{0} - \mathbf{D}_{-\mathcal{L}^*}^\top & \mathbf{0} \\
\end{bmatrix} 
\begin{bmatrix}
\mathbf{e}_{1} \\
\mathbf{e}_{2} \\
\end{bmatrix} + 
\begin{bmatrix}
\mathbf{0}\\
\mathbf{B}_2\\
\end{bmatrix}
\mathbf{u}_\partial, \\
\begin{bmatrix}
\mathbf{M}_1 & \mathbf{0} \\
\mathbf{0} & \mathbf{M}_2 \\
\end{bmatrix}
\begin{bmatrix}
\mathbf{e}_{1} \\
\mathbf{e}_{2} \\
\end{bmatrix}
&= \begin{bmatrix}
\nabla_{\bm{\alpha}_{d, 1}} H_d(\bm{\alpha}_d)\\
\nabla_{\bm{\alpha}_{d, 2}} H_d(\bm{\alpha}_d)\\
\end{bmatrix}, \\
\mathbf{M}_\partial {\mathbf{y}_\partial} &= 
\begin{bmatrix}
\mathbf{0} & \mathbf{B}_2^\top 
\end{bmatrix}\begin{bmatrix}
\mathbf{e}_{1} \\
\mathbf{e}_{2} \\
\end{bmatrix}.
\end{aligned}
\end{equation}
The differences with respect to formulation \eqref{eq:pHsys_findim_J1} reside in matrices $\mathbf{D}_{-\mathcal{L}^*}, \; \mathbf{B}_2$, whose definitions are
\begin{equation}
{D}_{-\mathcal{L}^*}^{ij} = \inner[X_1]{\phi_1^i}{\mathcal{-L^*}\phi_2^j}, \qquad B_2^{ik} = \inner[X_\partial]{\phi_2^i}{\phi_{\partial}^k} \qquad i \in \left\{1, n_1\right\}, \; j \in \left\{1, n_2\right\},\; k \in \left\{1, n_\partial \right\}.
\end{equation}
System \eqref{eq:pHsys_findim_J2} can be put in canonical form by replacing the co-energy variables by the discretized gradient.

\paragraph{Example: the irrotational shallow water equation}
Consider as an example the shallow water equations detailed in Sec \secref{sec:shallowwater}. If the flow is irrotational, then $\nabla \times \bm{v} = 0$.

\begin{equation}
\diffp{}{t}
\begin{pmatrix}
\alpha_h \\
\bm{\alpha}_v \\
\end{pmatrix} = 
\begin{bmatrix}
0 & -\div \\
-\grad & \mathcal{G}
\end{bmatrix}
\begin{pmatrix}
e_h \\
\bm{e}_v \\
\end{pmatrix},
\end{equation} 
\begin{equation*}
H(\alpha_h, \bm{\alpha}_v) = \frac{1}{2} \int_\Omega \frac{1}{\rho} \alpha_h \norm{\bm{\alpha}_v}^2 + \rho g \alpha_h^2 \d\Omega.
\end{equation*}

The co-energy variables are given by
\begin{equation*}
e_h := \diffd{H}{\alpha_h} = \frac{1}{2 \rho} \norm{\bm{\alpha}_v}^2 + \rho g \alpha_h, \qquad \bm{e}_v := \diffd{H}{\bm{\alpha}_v} = \frac{1}{\rho} \alpha_h \bm{\alpha}_v.
\end{equation*}
\subsection{Linear case}

\subsection{Examples}

\section{Inhomogeneous boundary conditions}\label{sec:mixedbc}

\subsection{Solution using Lagrange multipliers}

\subsection{Virtual domain decomposition}


\section{Connection with mixed finite elements}




